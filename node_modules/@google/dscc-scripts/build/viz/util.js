"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const Ajv = require("ajv");
const args_1 = require("../args");
const util_1 = require("../util");
const schemas_1 = require("./schemas");
exports.validateBuildValues = (args) => {
    const cssFile = process.env.npm_package_dsccViz_cssFile;
    if (cssFile === undefined) {
        throw util_1.invalidVizConfig('cssFile');
    }
    const jsonFile = process.env.npm_package_dsccViz_jsonFile;
    if (jsonFile === undefined) {
        throw util_1.invalidVizConfig('jsonFile');
    }
    const jsFile = process.env.npm_package_dsccViz_jsFile;
    if (jsFile === undefined) {
        throw util_1.invalidVizConfig('jsFile');
    }
    const devBucket = process.env.npm_package_dsccViz_gcsDevBucket;
    if (devBucket === undefined) {
        throw util_1.invalidVizConfig('gcsDevBucket');
    }
    const prodBucket = process.env.npm_package_dsccViz_gcsProdBucket;
    if (prodBucket === undefined) {
        throw util_1.invalidVizConfig('gcsProdBucket');
    }
    const devMode = args.deployment === args_1.DeploymentChoices.PROD ? false : true;
    const gcsBucket = devMode ? devBucket : prodBucket;
    const manifestFile = 'manifest.json';
    const pwd = process.env.PWD;
    return {
        devBucket,
        prodBucket,
        manifestFile,
        cssFile,
        jsonFile,
        jsFile,
        devMode,
        pwd,
        gcsBucket,
    };
};
const validateJSON = (jsonStr, schema, fn) => {
    const ajv = new Ajv({ allErrors: true });
    const jsonObject = JSON.parse(jsonStr);
    const testJson = ajv.compile(schema);
    const isValid = testJson(jsonObject);
    // testJson.errors
    if (isValid === false) {
        throw util_1.invalidVizJSON(fn, testJson.errors);
    }
    return isValid;
};
exports.validateConfig = (configContents) => {
    const filename = 'config';
    return validateJSON(configContents, schemas_1.configSchema, filename);
};
exports.validateManifest = (manifestContents) => {
    const filename = 'manifest';
    return validateJSON(manifestContents, schemas_1.manifestSchema, filename);
};
